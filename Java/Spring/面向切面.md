# 面向切面

#### 1. 切点表达式

- **arg()**：限制连接点匹配参数为指定类型的执行方法
- **@args()**：限制连接点匹配参数由指定注解的执行方法
- **execution()**：用于匹配是连接点的执行方法
- **this()**：限制连接点匹配AOP代理的bean引用为指定类型的类
- **target**：限制连接点匹配目标对象为指定类型的类
- **@target()**：限制连接点匹配特定的执行对象，这些对象对应的类要具有指定类型的注解

#### 2. 编写切点

假设这样一个场景：正在开一场音乐会，开始前人们要关闭手机，保持安静；而后演出进行，观众鼓掌；若演出砸了，观众要求退票。首先定义一个表演接口：

```java
public interface Performance {
    public void perform();
}
```

从演出的角度来看，观众很重要。但对于演出本身的功能而言，它并不是核心。它是一个独立的关注点，因此，观众作为一个切面。

```java
@Aspect         // 声明切面
public class Audience {

    // 声明切点，execution是切点表达式
    @Before("execution(* concert.Perfermance.perform(..))")  
    public void silenceCellPhones() {
        System.out.println("Silencing cell phone");   // perform执行前执行此方法
    }

    @Before("execution(* concert.Perfermance.perform(..))")
    public void takeSeats() {
        System.out.println("Taking seats");
    }

    @AfterReturning("execution(* concert.Perfermance.perform(..))")
    public void applause() {
        System.out.println("CLAP CLAP CLAP!!!");
    }

    @AfterThrowing
    public void demandRefund() {
        System.out.println("Demanding a refund");
    }
}
```

切点表达式有大量重复，我们可以利用@Pointcut注解来解决这个问题：

```java
@Aspect
public class Audience {

    @Pointcut("execution(* concert.Perfermance.perform(..))")
    public void performance() {}

    @Before("performance()")
    public void silenceCellPhones() {
        System.out.println("Silencing cell phone");
    }

    @Before("performance()")
    public void takeSeats() {
        System.out.println("Taking seats");
    }

    @AfterReturning("performance()")
    public void applause() {
        System.out.println("CLAP CLAP CLAP!!!");
    }

    @AfterThrowing("performance()")
    public void demandRefund() {
        System.out.println("Demanding a refund");
    }
}
```

#### 3. 启用自动切面代理

如果我们只是在普通的POJO上加了@Aspect注解的话，它仍就只会是一个普通的bean，不会被视为切面。为了让spring启用这个切面，需要进行自动代理配置：

```java
@Configuration
@EnableAspectJAutoProxy			// 启用自动代理
@ComponentScan
public class ConcertConfig {

    @Bean
    public Audience audience() {
        return new Audience();
    }
}
```

使用XML方式：

```xml
<aop:aspectj-autoproxy />
```

